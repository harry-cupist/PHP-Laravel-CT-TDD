데이터를 삭제하는 테스트 케이스도 유사한 방식으로 생성 가능

```php
/** @test */
public function a_book_can_be_deleted()
{
  $this->withoutExceptionHandling();
  
  $this->post('/books', [
    'title' => 'cool book title',
    'author' => 'harry'
  ]);

  $book = Book::first();
  $this->assertCount(1, Book::all());

  $response = $this->delete('/books/' . $book->id);

  $this->assertCount(0, Book::all());
}
```



DELETE http 메소드 라우터에 추가

```php
Route::delete('/books/{book}', 'BooksController@destroy');
```



컨트롤러에 destroy 메소드 추가

```php
public function destroy(Book $book)
{
  $book->delete();
}
```



index로 리다이렉션 설정

```php
$response = $this->delete('/books/' . $book->id);

$this->assertCount(0, Book::all());
$response->assertRedirect('/books');
```

```php
public function destroy(Book $book)
{
  $book->delete();

  return redirect('/books');
}
```



업데이트된 이후 show 페이지로 리 다이렉트 설정

```php
    /** @test */
    public function a_book_can_be_updated()
    {
        // $this->withoutExceptionHandling();

        $this->post('/books', [
            'title' => 'cool book title',
            'author' => 'harry'
        ]);

        $book = Book::first();

        $response = $this->patch('/books/' . $book->id, [
            'title' => 'New Title',
            'author' => 'victor',
        ]);

        $this->assertEquals('New Title', Book::first()->title);
        $this->assertEquals('victor', Book::first()->author);
      
      	// redirect 추가
        $response->assertRedirect('/books/' . $book->id); 
    }
```

컨트롤러에도 Redirect 추가

```php
public function update(Book $book)
{
  $book->update($this->validateRequest());

  return redirect('/books/' . $book->id);
}
```



동일한 방법으로 글 생성 후 show(상세페이지)로 넘어가게 설정

```php
public function a_book_can_be_added_to_the_library()
{
  $response = $this->post('/books', [
    'title' => 'cool book title',
    'author' => 'harry'
  ]);

  // 인스턴스 저장
  $book = Book::first();  

  $response->assertOk();
  $this->assertCount(1, Book::all());

  // 리다이렉트 설정
  $response->assertRedirect(('/books/' . $book->id));
}
```

```php
public function store()
{
  $book = Book::create($this->validateRequest());

  return redirect('/books/' . $book->id);
}
```



302 에러 발생함

```bash
Response status code [302] does not match expected 200 status code.
```

따라서 아래 코드 삭제를 해줘야함 (200 응답을 의미함)

```php
$response->assertOk(); // 제거할 것
```





#### 리다이렉트 리팩토링 (1)

show(상세페이지)로 리다이렉트하는 코드들이 반복적으로 사용되고 있음. 이를 모델의 메소드를 통해 리팩토링을 하도록 할 수 있음

```php
return redirect('/books/' . $book->id);
```

```php
class Book extends Model
{
    protected $guarded = [];

    public function path()
    {
        return '/books/' . $this->id;
    }
}
```

```php
public function store()
{
  $book = Book::create($this->validateRequest());

  // return redirect('/books/' . $book->id);
  return redirect($book->path());
}
```



#### 리다이렉트 리팩토링 (2) - optional

상세페이지에 id 뿐만아니라 제목도 같이 url에 뜨도록 설정하여 리다이렉트 시킬 수 있음

```php
use Illuminate\Support\Str;

public function path()
{
  return '/books/' . $this->id . '-' . Str::slug($this->title);

  // /books/1-endgame
}
```

마지막으로 BookReservationTest.php내에서  기존의 리다이렉트 포맷을 갖고 있는 코드를 업데이트 시킴

```php
$response->assertRedirect(('/books/' . $book->id));

$response->assertRedirect($book->path());
```



라우팅 경로 재설정

```php
Route::patch('/books/{book}-{slug}', 'BooksController@update');
```



업데이트 부분에서 에러가 발생함.

새롭게 업데이트된 title로 redirect 시켜야 하므로, 인스턴스를 새로고침하는 메소드를 추가해야함.

- fresh()

```php
$book = Book::first();

$response = $this->patch($book->path(), [
  'title' => 'New Title',
  'author' => 'victor',
]);

$this->assertEquals('New Title', Book::first()->title);
$this->assertEquals('victor', Book::first()->author);
// fresh() 추가
$response->assertRedirect($book->fresh()->path());
```



BookReservationTest.php 파일을 BookManagementTest.php파일로 이름 변경



#### Auth test

```php
php artisan make:test AuthorManagementTest
```

author 생성하는 테스트 케이스 기본 코드 작성

```php
class AuthorManagementTest extends TestCase
{
    use RefreshDatabase;
    /** @test */
    public function an_author_can_be_created()
    {
        $this->withoutExceptionHandling();

        $this->post('/author', [
            'name' => 'Author Name',
            'dob' => '05/14/1998'
        ]);

        $this->assertCount(1, Author::all());
    }
}
```

라우트 & 컨트롤러 추가

```php
Route::post('/author', 'AuthorsController@store');

class AuthorsController extends Controller
{
    public function store()
    {
    }
}

```



모델 생성 `php artisan make:model Author -m`  , 기본 코드 작성

test파일에 모델  import 

```php
use App\Author;

class AuthorsController extends Controller
{
    public function store()
    {
        Author::create(request()->only([
            'name', 'dob',
        ]));
    }
}
```



모델에 mass assignment 설정

```php
class Author extends Model
{
    protected $guarded = [];
}
```



마이그레이션 파일 수정

```php
        Schema::create('authors', function (Blueprint $table) {
            $table->bigIncrements('id');
            $table->string('name');  // 추가
            $table->timestamp('dob'); // 추가
            $table->timestamps();
        });
```



dob(date of birth)가 carbon instance로 오는지 확인 (날짜 양식이 맞는지)

```php
use Carbon\Carbon;

public function an_author_can_be_created()
{
  $this->withoutExceptionHandling();

  $this->post('/author', [
    'name' => 'Author Name',
    'dob' => '05/14/1998'
  ]);

  $author = Author::all();
  $this->assertCount(1, $author);
  $this->assertInstanceOf(Carbon::class, $author->first()->dob);
}
```



에러발생

```bash
Failed asserting that '05/14/1998' is an instance of class "Carbon\Carbon".
```



라라벨이 자동으로 데이터를 carbon instance로 넣어주고 싶을 경우, $data 배열에 추가하면됨.

```php
class Author extends Model
{
    protected $guarded = [];

    protected $dates = ['dob'];
}
```



또다른 에러 발생... 포맷팅을 커스텀으로 설정해줘야함.

```bash
InvalidArgumentException : Unexpected data found.
Unexpected data found.
Data missing
```



컨벤션 룰을 정확히따라줘야함. 인수에는 $attribute를 넣어도 되며, 우리는 이 상황에서 $dob가 들어오는 것을 알고있으므로 간단히 $dob를 인수로 받아옴.

- 컨벤션 : set + 컬럼명(첫글자 대문자로 시작) + Attribute

```php
class Author extends Model
{
    protected $guarded = [];

    protected $dates = ['dob'];

    public function setDobAttribute($dob)
    {
        $this->attributes['dob'] = Carbon::parse($dob);
    }
}
```



다른 포맷으로 들어오더라도, 포맷팅만 잘 비교해주면 상관없음

```php
$this->assertEquals('1998/14/05', $author->first()->dob->format('Y/d/m'));
```

