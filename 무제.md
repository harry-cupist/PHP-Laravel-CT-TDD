.env 

```php
DB_CONNECTION=sqlite
```

touch database/database.sqlite

```php
class BookReservationTest extends TestCase
{
    /** @test */
    public function a_book_can_be_added_to_the_library()
    {
        $response = $this->post('/books', [
            'title' => 'cool book title',
            'author' => 'harry'
        ]);

        $response->assertOk();
        $this->assertCount(1, book::all());
    }
}
```



alias pf='clear && phpunit --filter'





```php
$this->withoutExceptionHandling();  // 라라벨이 적당한 에러로 변경시켜서 보여줌.
```



라우터 생성

```php
Route::post('/book', 'BooksController@store');
```



컨트롤러 생성

```php
php artisan make:controller BooksController
```



store 메소드생성

```php
class BooksController extends Controller
{
    public function store()
    {
    }
}

```



모델 생성 & 마이그레이션

```php
php artisan make:model Book -m
```



테스트 파일 & 컨트롤러에 에 모델 import

 refreshDatabase 또한 클래스 내부에서 use 시킴. 단일 테스트 돌때마다 데이터베이스를 초기화 시키는 역할을 함.

```php
use App\Book;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

class BookReservationTest extends TestCase
{
    use refreshDatabase;
```



모델에 mass assignment 설정

```php
class Book extends Model
{
    protected $guarded = [];
}

```



마이그레이션에 title, author 추가

```php
public function up()
{
  Schema::create('books', function (Blueprint $table) {
    $table->bigIncrements('id');
    $table->string('title');
    $table->string('author');
    $table->timestamps();
  });
}
```



제목 유효성 검증에 대한 테스트케이스 작성

```php
/** @test */
public function a_title_is_required()
{
  $this->withoutExceptionHandling();
  $response = $this->post('/books', [
    'title' => '',
    'author' => 'harry'
  ]);

  $response->assertSessionHasErrors('title');
}
```



컨트롤러에 유효성 검증에 대한 코드 추가

```php
class BooksController extends Controller
{
    public function store()
    {
        $data = request()->validate([
            'title'=>'required',
            'author'=> 'required'
        ]);

        Book::create($data);
    }
}
```



모든 프로세스가 완료 되었으나, `withoutExceptionHandling()` 로 에러메세지가 반환되므로 이 부분은 주석처리

```php
/** @test */
public function a_title_is_required()
{
  //$this->withoutExceptionHandling();
  $response = $this->post('/books', [
    'title' => '',
    'author' => 'harry'
  ]);

  $response->assertSessionHasErrors('title');
}
```



마찬가지로, 작가명이 누락된 테스트케이스도 작성 가능

```php
/** @test */
public function an_author_is_required()
{
  // $this->withoutExceptionHandling();
  $response = $this->post('/books', [
    'title' => 'cool book title',
    'author' => ''
  ]);

  $response->assertSessionHasErrors('author');
}
```





#### update

```php
/** @test */
public function a_book_can_be_updated()
{
  $this->withoutExceptionHandling();
  $this->post('/books', [
    'title' => 'cool book title',
    'author' => 'harry'
  ]);

  $response = $this->patch('/books', [
    'title' => 'New Title',
    'author' => 'Victor',
  ]);

  $this->assertEquals('New Title', Book::first()->title);
  $this->assertEquals('harry', Book::first()->author);

}
```



Http 메소드 에러 발생

```bash
Symfony\Component\HttpKernel\Exception\MethodNotAllowedHttpException : The PATCH method is not supported for this route. Supported methods: POST.
```



Web.php에서 라우트 추가

```php
Route::patch('/books', 'BooksController@update');
```



컨트롤러에 메소드 추가

```php
    public function update()
    {
        $data = request()->validate([
            'title'=>'required',
            'author'=> 'required',
        ]);
    }
```



그러나 어떤 책에 대하여 업데이트를 하는지 알기위해 id값을 사용해야함

```php
    /** @test */
    public function a_book_can_be_updated()
    {
        $this->withoutExceptionHandling();

        $this->post('/books', [
            'title' => 'cool book title',
            'author' => 'harry'
        ]);

        $book = Book::first();  // book 클래스 인스턴스 추가

        $response = $this->patch('/books/' . $book->id, [ //id값을 variable routing으로 사용
            'title' => 'New Title',
            'author' => 'Victor',
        ]);
```



web.php와 컨트롤러 수정

```php
Route::patch('/books/{book}', 'BooksController@update');
```

```php
public function update(Book $book)  // route model binding
{
  $data = request()->validate([
    'title'=>'required',
    'author'=> 'required',
  ]);
  
  $book->update($data);
}
```



현재까지 모든 테스트케이스가 성공적으로 작동함

```php
// BooksController.php
namespace App\Http\Controllers;

use App\Book;
use Illuminate\Http\Request;

class BooksController extends Controller
{
    public function store()
    {
        $data = request()->validate([
            'title'=>'required',
            'author'=> 'required',
        ]);

        Book::create($data);
    }

    public function update(Book $book)
    {
        $data = request()->validate([
            'title'=>'required',
            'author'=> 'required',
        ]);

        $book->update($data);
    }
}
```

```php
//web.php

Route::post('/books', 'BooksController@store');
Route::patch('/books/{book}', 'BooksController@update');
```

```php
// BookReservationTest.php
namespace Tests\Feature;

use App\Book;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

class BookReservationTest extends TestCase
{
    use refreshDatabase;

    /** @test */
    public function a_book_can_be_added_to_the_library()
    {
        $this->withoutExceptionHandling();
        $response = $this->post('/books', [
            'title' => 'cool book title',
            'author' => 'harry'
        ]);

        $response->assertOk();
        $this->assertCount(1, Book::all());
    }

    /** @test */
    public function a_title_is_required()
    {
        // $this->withoutExceptionHandling();
        $response = $this->post('/books', [
            'title' => '',
            'author' => 'harry'
        ]);

        $response->assertSessionHasErrors('title');
    }

    /** @test */
    public function an_author_is_required()
    {
        $response = $this->post('/books', [
            'title' => 'cool book title',
            'author' => ''
        ]);

        $response->assertSessionHasErrors('author');
    }

    /** @test */
    public function a_book_can_be_updated()
    {
        $this->withoutExceptionHandling();

        $this->post('/books', [
            'title' => 'cool book title',
            'author' => 'harry'
        ]);

        $book = Book::first();

        $response = $this->patch('/books/' . $book->id, [
            'title' => 'New Title',
            'author' => 'victor',
        ]);

        $this->assertEquals('New Title', Book::first()->title);
        $this->assertEquals('victor', Book::first()->author);
    }
}
```



#### 리팩토링

유효성 검증하는 부분을 메소드로 extract 시킴. 

```php
$data = request()->validate([
  'title'=>'required',
  'author'=> 'required',
]);
```

```php
public function store()
{
  $data = $this->validateRequest();

  Book::create($data);
}

public function update(Book $book)
{
  $data = $this->validateRequest();

  $book->update($data);
}

/**
* @return mixed
*/
public function validateRequest()
{
  return request()->validate([
    'title'  => 'required',
    'author' => 'required',
  ]);
}
```

$data를 인라인으로 변경하는 것도 가능

리팩토링 최종 완성된 코드는 다음과 같음.

```php
class BooksController extends Controller
{
    public function store()
    {
        Book::create($this->validateRequest());
    }

    public function update(Book $book)
    {
        $book->update($this->validateRequest());
    }

    /**
     * @return mixed
     */
    public function validateRequest()
    {
        return request()->validate([
            'title'  => 'required',
            'author' => 'required',
        ]);
    }
}
```

